#!/bin/sh
#
# Souffle - A Datalog Compiler
# Copyright (c) 2013-14, Oracle and/or its affiliates. All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at:
# - https://opensource.org/licenses/UPL
# - <souffle root>/licenses/SOUFFLE-UPL.txt

#
# script that compiles a generated C++ program and executes it
#

# Show usage
usage() {
  printf "Name:
  souffle-compile - compile a C++ source file generated by souffle
Usage:
  souffle-compile [options] <FILE>.cpp
Options:
  -h           show usage
  -s           compile a program with OpenMP support
  -v           verbose output
  -w           enable warnings\n"
  exit 1;
}

# Print a message to STDERR and exit. If the second argument (exit code)
# is provided and it is '0' then do nothing, otherwise print the error message
# along with the usage (if the third argument is defined)
error() {
  if [ -z "$2" ] || ! [ "$2" = 0 ]; then
    echo "souffle-compile error: $1" 1>&2
    if [ -n "$3" ]; then
      usage;
    fi
    exit 1;
  fi
}

## set environment variables

# set by autoconf
CXX=@CXX@
CXXFLAGS="@CXXFLAGS@"
LDFLAGS="@LDFLAGS@"
LIBS="@LIBS@"
OMP_FLAG="@OPENMP_CFLAGS@"

# set by command flags
WARNINGS=""

# find header files of souffle
TEST_HEADER="souffle/CompiledRamRelation.h"
HEADER_DIR=$(dirname $0)/../include
test -f "$HEADER_DIR/$TEST_HEADER"
error "installation error: souffle header files cannot be found" $?

# Options processing via getopts builtin, it is very limiting but on OSX the
# default getopt is an old BSD getopt, so need this for portability
while getopts "hwvs" opt; do
  case "$opt" in
    h|\?) # Show usage and exit
      usage;
    ;;
    w) # enable warnings
      WARNINGS="1"
    ;;
    v) # Verbose output
      set -x
    ;;
    s) # compile without openmp
      OMP_FLAG=""
    ;;
  esac
done

# Shift positional arguments
shift $(($OPTIND - 1))

# Show usage if no input is given
test -n "$1"
error "no input file" $? 1

# Check if the input file exists
test -f "$1"
error "cannot open source file: '$1'" $?

# Check if the input file has a valid extension
exe=`basename $1 .cpp`
test "$1" != "$exe"
error "source file is not a .cpp file: '$1'" $?

# Compile
rm -f ./$exe
$CXX $CXXFLAGS -o./$exe $1 $LIBS -I$HEADER_DIR $OMP_FLAG 2> ./$exe.$$.ccerr
if test -f ./$exe
then
  if [ "$WARNINGS" = 1 ]
  then
     echo "$CXX $CXXFLAGS -o./$exe $1 $LIBS -I$HEADER_DIR $OMP_FLAG"
     cat ./$exe.$$.ccerr 1>&2
  fi
  rm ./$exe.$$.ccerr
else
  echo "compiler error: cannot compile source file $1" 1>&2
  echo "$CXX $CXXFLAGS -o./$exe $1 $LIBS -I$HEADER_DIR $OMP_FLAG"
  cat ./$exe.$$.ccerr 1>&2
  rm -f ./$exe.$$.ccerr
  exit 1
fi
exit 0
